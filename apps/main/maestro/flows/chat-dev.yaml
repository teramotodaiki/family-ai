appId: ${APP_ID}
name: Chat DEV flow (deep link to Metro)
tags:
  - e2e
  - chat
env:
  INPUT_TEXT: "こんにちは"
  APP_SCHEME: "familyai"
  DEV_URL: "http://192.168.68.53:8081"
onFlowStart:
  - stopApp: {}
  - clearState: {}
  - launchApp:
      appId: ${APP_ID}
      clearState: true
      permissions:
        notifications: allow
        camera: deny
        photos: deny
        microphone: deny
---
 - openLink:
     link: "${APP_SCHEME}://expo-development-client/?url=${DEV_URL}"

 # iOS 確認ダイアログ（“main”で開く？）許可（任意・多言語）
 - tapOn:
     text: "開く"
     optional: true
 - tapOn:
     text: "Open"
     optional: true

 # 初回のみ表示されるモーダル等（任意）
 - tapOn:
     text: "Continue"
     optional: true
 - tapOn:
     text: "×"
     optional: true

 # ランチャー画面フォールバック（任意）
 - tapOn:
     text: "${DEV_URL}"
     optional: true
 - tapOn:
     text: "localhost:8081"
     optional: true
 - tapOn:
     text: "192.168.68.53:8081"
     optional: true
 - tapOn:
     text: "http://192.168.68.53:8081"
     optional: true

 # Dev Menu が開いている場合に閉じる（任意・文言差吸収）
 - tapOn:
     text: "Go home"
     optional: true
 - tapOn:
     text: "ホームに戻る"
     optional: true
 - tapOn:
     text: "Close"
     optional: true
 - tapOn:
     text: "閉じる"
     optional: true

 - extendedWaitUntil:
     visible:
       id: "chat-input"
     timeout: 90000

 - tapOn:
     id: "chat-input"

 - inputText: ${INPUT_TEXT}

 - hideKeyboard: {}

 - tapOn:
     id: "send-button"

 - extendedWaitUntil:
     visible:
       id: "message-assistant"
     timeout: 30000

 # APIキー未設定時のエラー（任意で確認）
 - assertVisible:
     text: "APIキーが設定されていません"
     optional: true

 # 送受信の両方の吹き出しが少なくとも1件あること
 - assertVisible:
     id: "message-user"
 - assertVisible:
     id: "message-assistant"
